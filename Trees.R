#preprocessing
newdata = read.csv("data.csv",as.is =TRUE, header=FALSE)
trainLabels = read.csv("trainLabels.csv", as.is =TRUE)

#combine data wiht trainLabels
newtrain = merge(newdata,trainLabels, by.x ="V42", by.y ="Id")
#order columns in train
order = append(setdiff(names(newtrain),c('V42','Class')) , c('V42','Class'))
newtrain = newtrain[c(order)]

#For testing only
library(caTools)
leftOut = setdiff(names(newtrain), "V42")
set.seed(100)
split=sample.split(newtrain$Class,SplitRatio = 0.7)
sampleTrain = subset(newtrain,split==TRUE)
sampleTest = subset(newtrain,split==FALSE)
sampleTrain = sampleTrain[c(leftOut)]
sampleTest = sampleTest[c(leftOut)]

#Removing the non numeric columns

trainFinal = newtrain[c(leftOut)]



#Train CART
require(rpart)
require(rpart.plot)
# Feature Selection
#leftOuts = setdiff(names(trainFinal), c('V40','V41'))
trainForCART = trainFinal

modelCART = rpart(Class~.,data=trainForCART,method="class")
prp(modelCART)
#predCART = predict(modelCART,newdata=sampleTest,type="class")

#table(sampleTest$Class,predCART)

#Cross-validation
library(caret)
library(e1071)
set.seed(2)
numFolds=trainControl(method="cv",number=10)
CARTgrid = expand.grid( .cp = seq(0.002,0.1,0.002))

final = train(Class~.,data=trainForCART,method="rpart",trControl = numFolds, tuneGrid = CARTgrid )

modelCART2 = rpart(Class~.,data=trainForCART,method="class",cp=0.002)
prp(modelCART)


#train randomforest
library(randomForest)
set.seed(1)
trainForCART$Class = as.factor(trainForCART$Class)
modelRT = randomForest(Class~.,data=trainForCART)

#For test preprocess it
test=read.csv("data3.csv",as.is=TRUE,header=FALSE)
#remove filename
#adjust columns and set col names
leftOuts = setdiff(names(test), c('V42'))
testFinal = test[c(leftOuts)]
predCART = predict(modelCART2,newdata=testFinal,type="response")

predRT = predict(modelRT,newdata=testFinal,type="response")


#Feature Selection:
rfRFE =  list(summary = defaultSummary,
               fit = function(x, y, first, last, ...){
                 library(randomForest)
                 randomForest(x, y, importance = first, ...)
               },
               pred = function(object, x)  predict(object, x),
               rank = function(object, x, y) {
                 vimp <- varImp(object)
                 vimp <- vimp[order(vimp$Overall,decreasing = TRUE),,drop = FALSE]
                 vimp$var <- rownames(vimp)
                 vimp
               },
               selectSize = pickSizeBest,
               selectVar = pickVars)

ctrl = rfeControl(functions = rfRFE,
                   method = "repeatedcv",
                   repeats = 5,
                   verbose = FALSE,
                   returnResamp <- "all")

subsets = c(1:5, 10, 15, 20, 25)
rfProfile = rfe(sampleTrain[0:41],sampleTrain$Class,sizes=subsets,rfeControl=ctrl)

normTrain = preProcess(trainFinal[0:41])
normTrain = trainFinal[0:41]
pre=preProcess(normTrain)
normTrain = predict(pre,normTrain)
trainFinal$Class= as.factor(trainFinal$Class)

pre=preProcess(testFinal)
testNorm = predict(pre,testFinal)

finalMod = rfe(train2,train$class,sizes=c(16:150),rfeControl=rfeControl(functions = rfFuncs,method = "repeatedcv",
                                                     repeats = 5))

#final = rfe(sampleTrain[0:41],sampleTrain$Class,rfeControl=rfeControl(functions = rfFuncs,method="cv"))